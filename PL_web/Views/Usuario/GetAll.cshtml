@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<h2>Lista de Usuarios</h2>

<input type="text" id="busquedaNombre" placeholder="Buscar por Nombre" class="form-control mb-3" />
<button id="btnBuscar" class="btn btn-primary mb-3">Buscar</button>

<div class="table table-responsive">
    <table class="table table-dark table-striped" id="tablaUsuarios">
        <thead>
            <tr>
                <th>Nombre Completo</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Dirección</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        var token = localStorage.getItem("jwtToken");
        var token2 = ""; //Manual

        function cargarUsuarios(filtroNombre = "") {
            $.ajax({
                url: "http://localhost:5075/api/Usuario/GetAll",
                type: "POST",
                contentType: "application/json",
                headers: {
                    "Authorization": "Bearer " + token //Cambiar por el TOKEN correcto
                },
                data: JSON.stringify({
                    //Parámetros obligatorios
                    nombreCompleto: filtroNombre,
                    email: "",
                    contrasena: "",
                    rol: {
                        idRol: 0
                    }
                }),

                success: function (response) {
                    var usuarios = response.objects;
                    $("#tablaUsuarios tbody").empty(); // limpiar tabla

                    $.each(usuarios, function (i, usuario) {
                        $("#tablaUsuarios tbody").append(
                            `<tr>
                                <td>${usuario.nombreCompleto}</td>
                                <td>${usuario.email}</td>
                                <td>${usuario.rol.nombre}</td>
                                <td>${usuario.direccion.calle}, ${usuario.direccion.numeroInterior}, ${usuario.direccion.numeroExterior},
                                colonia ${usuario.direccion.colonia.nombre}, delegación ${usuario.direccion.colonia.municipio.nombre}, 
                                ${usuario.direccion.colonia.municipio.estado.nombre}</td>
                            </tr>`
                        );
                    });
                },
                error: function (error) {
                    console.log("Error al consumir el API:", error);
                    console.log(error.responseText);
                }
            });
        }

        //🔄 Carga automática al abrir la vista
        cargarUsuarios(); //sin filtro

        //🕵️ Evento de búsqueda por Nombre
        $("#btnBuscar").click(function () {
            var usuario = $("#busquedaNombre").val();
            cargarUsuarios(usuario);
        });

        //Evento de búsqueda por IdRol
    });
</script>